CREATE DATABASE BDESTACIONAMENTO;

USE BDESTACIONAMENTO;
/*
CREATE TABLE TBCATEGORIA (
IDCAT INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
PRECO_PRIMEIRA_HORA DECIMAL(5,2) NOT NULL,
PRECO_HORAS_ADICIONAIS DECIMAL(5,2) NOT NULL,
PRECO_DIARIA DECIMAL(5,2) NOT NULL
); */

CREATE TABLE TBCLIENTE (
IDCLIENTE INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
NOMECLIENTE VARCHAR(30) NOT NULL,
TELEFONECLIENTE VARCHAR(14) NOT NULL,
CPFCLIENTE VARCHAR(14) NOT NULL UNIQUE
);

CREATE TABLE TBVEICULO (
IDVEICULO INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
CODCLIENTE INT NULL,
PLACAVEICULO VARCHAR (7) NOT NULL UNIQUE,
MODELOVEICULO VARCHAR(15) NOT NULL,
TIPOVEICULO VARCHAR(10) NOT NULL,
FOREIGN KEY (CODCLIENTE) REFERENCES TBCLIENTE (IDCLIENTE) ON DELETE CASCADE ON UPDATE CASCADE
)ENGINE=INNODB;

CREATE TABLE TBFUNCIONARIO (
IDFUNCI INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
SENHAFUNCI VARCHAR(30) NOT NULL UNIQUE,
TELEFONEFUNCI VARCHAR(14) NOT NULL,
EMAILFUNCI VARCHAR(50) NOT NULL,
CPFFUNCI VARCHAR(14) NOT NULL UNIQUE,
NOMEFUNCI VARCHAR(30) NOT NULL,
STATUSFUNCI ENUM('ATIVO', 'INATIVO') NOT NULL DEFAULT 'ATIVO'
);

CREATE TABLE TBSERVICO (
IDSERVICO INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
CODCAT INT NOT NULL,
CODVEICULO INT NOT NULL,
CODFUNCI_ENTRADA INT NOT NULL,
CODFUNCI_SAIDA INT NULL,
DATAFINAL DATE NULL,
DATAINICIAL DATE NOT NULL,
HORAENTRADA TIME NOT NULL,
HORASAIDA TIME NULL,
VALORTOTAL DECIMAL(10,2) NULL,
STATUSSERVICO VARCHAR(15) NOT NULL,
FOREIGN KEY (CODCAT) REFERENCES TBCATEGORIA (IDCAT) ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY (CODVEICULO) REFERENCES TBVEICULO (IDVEICULO) ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY (CODFUNCI_ENTRADA) REFERENCES TBFUNCIONARIO (IDFUNCI) ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY (CODFUNCI_SAIDA) REFERENCES TBFUNCIONARIO (IDFUNCI) ON DELETE CASCADE ON UPDATE CASCADE
)ENGINE=INNODB;

/*Consultar o nome do funcionário de ID=3 e quantidade de serviços feitos por ele no mês de setembro*/
SELECT F.NOMEFUNCI, COUNT(S.DATAINICIAL)
FROM tbfuncionario F
INNER JOIN tbservico S
ON F.IDFUNCI=S.CODFUNCI_entrada
WHERE F.IDFUNCI=3 AND S.DATAINICIAL BETWEEN "2025-09-01" AND "2025-09-30";

/*Consultar os nomem dos funcionários e quantidades de serviços feitos por eles*/
SELECT F.NOMEFUNCI, COUNT(S.DATAINICIAL)
FROM tbfuncionario F
INNER JOIN tbservico S
ON F.IDFUNCI=S.CODFUNCI_entrada
GROUP BY F.IDFUNCI;

/*Consultar os dados das tabelas TBCLIENTE e TBVEICULO mostrando o nome dos clientes que possuem carro e não possuem credencial.*/
SELECT C.NOMECLIENTE, V.MODELOVEICULO
FROM tbcliente C
INNER JOIN tbveiculo V
ON C.IDCLIENTE=V.CODCLIENTE
WHERE V.TIPOVEICULO="MÉDIO";

/*Consultar o modelo do veículo e a suas respectivas datas de entrada e saída para cada moto //obs: a profª Fabi disse não haver visto sentido nessa consulta*/
SELECT V.MODELOVEICULO, S.DATAINICIAL, S.DATAFINAL
FROM tbveiculo V
INNER JOIN tbservico S
ON V.IDVEICULO = S.CODVEICULO
WHERE V.TIPOVEICULO = "PEQUENO";


/* Mostra quais veículos estão atualmente em um serviço */
SELECT VEI.PLACAVEICULO, VEI.MODELOVEICULO, S.DATAINICIAL, S.HORAENTRADA
FROM TBSERVICO S
INNER JOIN TBVEICULO VEI
ON S.CODVEICULO = VEI.IDVEICULO
WHERE S.STATUSSERVICO = 'ATIVO'; 

/* Calcula o total de horas e preço da estadia no estacionamento... */
SELECT
    CLI.NOMECLIENTE AS CLIENTE,
    VEI.PLACAVEICULO AS PLACA,
    VEI.MODELOVEICULO AS MODELO,
/* TIMESTAMPDIFF: função que calcula a diferença entre dois valores de data, hora ou carimbo de data/hora (timestamp);
    Retorna em um valor de intervalo de tempo horas, minutos, segundos, etc... */
/* CONCAT: Concatena Strings, nesse caso está combinando DATE e TIME para formar um DATATIME. */
    TIMESTAMPDIFF(MINUTE,
        CONCAT(S.DATAINICIAL, ' ', S.HORAENTRADA),
        CONCAT(S.DATAFINAL, ' ', S.HORASAIDA)
    )/60 AS DURACAO_EM_HORAS,
/* calcula o custo Total: duração (em horas) * preço por hora */
    (TIMESTAMPDIFF(MINUTE,
        CONCAT(S.DATAINICIAL, ' ', S.HORAENTRADA),
        CONCAT(S.DATAFINAL, ' ', S.HORASAIDA)
    )/60) AS DURACAO_MINUTOS_TOTAL,
    CASE
        WHEN (TIMESTAMPDIFF(MINUTE,
        CONCAT(S.DATAINICIAL, ' ', S.HORAENTRADA),
        CONCAT(S.DATAFINAL, ' ', S.HORASAIDA)
        )/60) <= 1
    THEN CAT.PRECO_PRIMEIRA_HORA
     
    ELSE
     CAT.PRECO_PRIMEIRA_HORA + CAT.PRECO_HORAS_ADICIONAIS*(CEIL((TIMESTAMPDIFF(MINUTE,
        CONCAT(S.DATAINICIAL, ' ', S.HORAENTRADA),
        CONCAT(S.DATAFINAL, ' ', S.HORASAIDA)
    )/60)-1))
    END AS PRECO_TOTAL
FROM
    tbservico S
INNER JOIN
    tbcategoria CAT ON CAT.IDCAT = S.CODCAT
INNER JOIN
    tbveiculo VEI ON VEI.IDVEICULO = S.CODVEICULO
INNER JOIN
    tbcliente CLI ON VEI.CODCLIENTE = CLI.IDCLIENTE
WHERE
/* Filtra apenas por serviços finalizados para cálculo de preço */
    S.STATUSSERVICO = 'FINALIZADO' 
ORDER BY 
    S.IDSERVICO ASC;
   
SELECT c.NOMECLIENTE AS nomecliente, c.CPFCLIENTE AS cpfcliente, c.TELEFONECLIENTE AS telefonecliente, v.PLACAVEICULO AS placaveiculo, v.MODELOVEICULO AS modeloveiculo, v.TIPOVEICULO AS tipoveiculo
FROM tbcliente c
INNER JOIN tbveiculo v
ON v.CODCLIENTE=c.IDCLIENTE;